<!-- escolher o plano e alterar os dados sem criar outro html na pagina de pagamento, ajuda com json, algumas coisas não entendi -->

<!-- Apos adaptar o site para o mobile, atualizar o navegador para a tela ficar responsiva -->
<!DOCTYPE html>
<html lang="Pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="../assets/css/styletelaempresa.css">
  <link rel="shortcut icon" href="../assets/img/logo.png" type="image/x-icon">
  <title>Tela Inicial - DataStock</title>
</head>

<body id="error">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
    }

    .chart {
      width: 800px;
      max-width: 100%;
      height: auto;
      margin: 20px auto;
      position: relative;
    }



    .line {
      fill: none;
      stroke: #007bff;
      stroke-width: 2;
    }

    .dot {
      fill: #007bff;
      stroke: #fff;
      stroke-width: 2;
    }

    .tooltip:hover {
      position: absolute;
      background: rgba(3, 3, 251, 0.7);
      color: #fff;
      padding: 5px;
      border-radius: 5px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      margin: top auto;
    }

    .tooltip.active {
      padding: 10px;
      opacity: 2;
      background: rgba(3, 3, 251, 0.7);
      color: white;
      border-radius: 10px;

    }

    .opcao {
      display: inline-block;
      border-left: none;
      border-right: none;
      padding: 5px;
      border-style: solid;
      border-width: 0 0 5px 0;
      border-image: linear-gradient(to left, blue, #0d6dfdb7 50%) 10 10;
    }
  </style>
  <!-- cabeçalho -->
  <header>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
      <div class="container-fluid">
        <a class="navbar-brand" href="../html/telaempres.html">
          <img src="../assets/img/logo.png" alt="DataStock" width="70" height="50">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
          aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
      </div>
      <div class="collapse navbar-collapse m-2" id="navbarNavAltMarkup">
        <div class="navbar-nav">
          <a class="nav-link active" aria-current="page" href="#">Inicio</a>
          <a class="nav-link" aria-current="page" href="conf.html">Configuração</a>
          <a class="nav-link" aria-current="page" href="Planos.html">Planos</a> <!-- remover futuramente -->

        </div>
      </div>
    </nav>
  </header>
  <!-- Fim cabeçalho -->
  <main>
    <!-- Inicio logo cliente -->
    <div class="container-fluid">
      <div class="row">
        <div class="col-lg-12 d-flex justify-content-center mb-3 mt-3" id="logocliente">
          <div id="logocliente"
            style="width: 100px; height: 100px; background-color: black; background-image: url(https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQZcmPBsVjXbWFmp12w0eGNXpQP4gnFvClKkLhUMbqKig&s); background-position: center; background-repeat: no-repeat; background-size: cover;">
          </div>
        </div>
      </div>
    </div>
    <!-- Fim logo Cliente -->
    <!-- Inicio Opções -->
    <div class="container w-75">
      <hr>
      <h1 class="opcao">Opções</h1>
      <div class="row mt-4 mb-4 d-flex justify-content-center flex-wrap">
        <button type="button" class="btn btn-outline-primary col-lg-3 col-5 col-md-3 mb-2 ms-2"
          onclick="window.location.href = 'PRODUCAO.html'"><img src="../assets/img/add.png" alt=""
            style="width:30px;"><strong> Produção</strong></button>
        <button type="button" class="btn btn-outline-primary col-lg-3 col-5 col-md-3 mb-2 ms-2"
          onclick="window.location.href = 'produtos.html'"><img src="../assets/img/barcode.png" alt=""
            style="width:30px;"><strong> Produtos</strong></button>
        <button type="button" class="btn btn-outline-primary col-lg-3 col-5 col-md-3 mb-2 ms-2"
          onclick="window.location.href = 'Rascunhos.html'"><img src="../assets/img/rascunho.png" alt=""
            style="width:30px;"><strong> Rascunhos</strong></button>
        <button type="button" class="btn btn-outline-primary col-lg-3 col-5 col-md-3 mb-2 ms-2"
          onclick="window.location.href = 'fornecedores.html'"><img src="../assets/img/truck.png" alt=""
            style="width:30px;"><strong> Fornecedores</strong></button>
        <button type="button" class="btn btn-outline-primary col-lg-3 col-5 col-md-3 mb-2 ms-2"
          onclick="window.location.href = 'clientes.html'"><img
            src="../assets/img/material-symbols--clinical-notes-outline.png" alt="" style="width:30px;"
            onclick="window.location.href = 'clientes.html'"><strong> Clientes</strong></button>
        <button type="button" class="btn btn-outline-primary col-lg-3 col-5 col-md-3 mb-2 ms-2"
          onclick="window.location.href = 'vendas.html'"><img src="../assets/img/loha.png" alt="" style="width:30px;"
            onclick="window.location.href = 'vendas.html'"><strong> Setor de Vendas</strong></button>
      </div>
    </div>
    <!-- Fim Opções -->
    <!-- Inicio da sessão do Gráfico  -->
    <!-- Inicio gráfico -->
    <div class="container w-75">
      <h1 class="opcao"><img src="../assets/img/grafico.png" alt="" style="width: 30px;margin-bottom: 15px;">
        Gráfico total de vendas</h1>
      <div class="row">
        <div class="col-lg-12 col-12 col-md-12 d-flex justify-content-center" id="disponivel">
          <script src="https://d3js.org/d3.v7.min.js"></script>
          <script>
            const vendeo = {
              "vendeu": "<div class='chart'></div>",
              "naovendeu": "<div class='p-1 mt-3 mb-2 bg-primary' style='border-radius: 10px;'><div class='container w-75 mx-auto bg-primary' style='border-radius: 10px;'><div class='row'><div class='col-lg-12 col-md-12 col-12'><img src='../assets/img/logo.png' style='width: 100px; margin-top: 30px; margin-bottom: 30px; background-color: white; padding: 10px; border-radius: 10px; margin: center;'><h1 class='text-white p-2' >Ops! O plano comprado não permite acesso ao gráfico. Faça um updade e tenha acesso agora mesmo!</h1><p class='text-white p-2'>-Me chama de termômetro e vem medir o calor das vendas comigo...Não? Desculpe, o estagiario está maluco.</p><br><a href='./Planos.html'><button type='button' class='btn mt-3 mb-3 w-100' style='background-color: white'><strong class='text-primary'>Ver Planos</strong></button></a></div></div></div></div>",
              "naovendeuu": "<div class='p-1 mt-3 mb-2 bg-primary' style='border-radius: 10px;'><div class='container w-75 mx-auto bg-primary' style='border-radius: 10px;'><div class='row'><div class='col-lg-12 col-md-12 col-12'><img src='../assets/img/logo.png' style='width: 100px; margin-top: 30px; margin-bottom: 30px; background-color: white; padding: 10px; border-radius: 10px; margin: center;'><h1 class='text-white p-2' >Parece que você não vendeu nenhum produto ainda, por isso o gráfico não surgiu ainda. </h1><p class='text-white p-2'>Registre uma venda para o gráfico surgir! Vamos ver esse gráfico subir juntos! <3</p><br></div></div></div></div>"
            }
            var planoEscolhido = localStorage.getItem('confirmacao');
            var local = document.getElementById('disponivel');
            const vendasMensais = JSON.parse(localStorage.getItem('vendasMensais'))
            if (planoEscolhido == 'false') {
              local.innerHTML = vendeo.naovendeu;
            } else if (vendasMensais == null && planoEscolhido == 'true'){ local.innerHTML = vendeo.naovendeuu }
            else {
              local.innerHTML = vendeo.vendeu
              // else {
              //   window.location.href = 'Planos.html'; ----------> Fazer algo parecido, mas levar para a tela de login
              // }

              // Dimensões do gráfico
              const margin = { top: 20, right: 30, bottom: 50, left: 60 };
              let width = document.querySelector('.chart').clientWidth;
              let height = width * 0.6;

              // SVG
              const svg = d3.select('.chart')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

              // Escala X
              const x = d3.scaleBand()
                .domain(vendasMensais.map(d => d.mes))
                .range([margin.left, width - margin.right])
                .padding(0.1);

              // Escala Y
              const y = d3.scaleLinear()
                .domain([0, d3.max(vendasMensais, d => parseInt(d.vendas))])
                .range([height - margin.bottom, margin.top]);

              // Desenhar a linha
              const line = d3.line()
                .x(d => x(d.mes) + x.bandwidth() / 2)
                .y(d => y(parseInt(d.vendas)));

              svg.append('path')
                .datum(vendasMensais)
                .attr('class', 'line')
                .attr('d', line)
                .attr('fill', 'none')
                .attr('stroke', 'steelblue')
                .attr('stroke-width', 2);

              // Adicionar pontos
              svg.selectAll('.dot')
                .data(vendasMensais)
                .enter()
                .append('circle')
                .attr('class', 'dot')
                .attr('cx', d => x(d.mes) + x.bandwidth() / 2)
                .attr('cy', d => y(parseInt(d.vendas)))
                .attr('r', 5)
                .attr('fill', 'steelblue')
                .on('mouseenter', function (event, d) {
                  d3.select(this).attr('r', 8);
                  tooltip.text(`Mês: ${d.mes}, Vendas: ${d.vendas}, Ano: ${d.ano}`);
                  tooltip.attr('class', 'tooltip active');
                })
                .on('mouseleave', function () {
                  d3.select(this).attr('r', 5);
                  tooltip.attr('class', 'tooltip');
                });

              // Eixos
              const xAxis = g => g
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x).tickSizeOuter(0));

              const yAxis = g => g
                .attr('transform', `translate(${margin.left},0)`)
                .call(d3.axisLeft(y));

              svg.append('g').call(xAxis);
              svg.append('g').call(yAxis);

              // Tooltip
              const tooltip = d3.select('.chart')
                .append('div')
                .attr('class', 'tooltip');

            }

          </script>



        </div>
        <!-- fim Gráfico -->
        <!-- Inicio tabela -->

        <div class="container mt-3" id="table+">


          <div class="card border-primary">
            <div class="card-body border-primary">
              <h5 class="opcao card-title"><img src="../assets/img/clock.png" alt=""
                  style="width: 30px; margin-right: 10px;" id="icos">Proximos do
                vencimento ou Vencidos</h5>
              <div class="table-responsive">
                <table class="table table-bordered border-primary">
                  <thead>
                    <tr>
                      <th class="bg-primary text-white" scope="col"
                        style="border-left: 1px solid #007bff; border-right: 1px solid white;">Nome</th>
                      <th class="bg-primary border-white text-white" scope="col">Quantidade</th>
                      <th class="bg-primary border-white text-white" scope="col">Valor Unitário(R$)</th>
                      <th class="bg-primary border-white text-white" scope="col" class="bg-primary">Validade</th>
                      <th class="bg-primary border-white text-white" scope="col">NCM</th>
                      <th class="bg-primary text-white" scope="col"
                        style="border: 1px solid #007bff; border-left: 1px solid white;">Unidade</th>
                    </tr>
                  </thead>

                  <tbody id="tabela-corpo">
                    <!-- Os dados da tabela serão preenchidos dinamicamente aqui -->
                  </tbody>
                </table>
                <span class="ms-2">*A ordenação da tabela é feita de acordo com o vencimento do produto</span>
                <span>e produtos indisponiveis para venda não é mostrado na tabela</span>
                <nav aria-label="..." class="d-flex justify-content-center">
                  <ul class="pagination pagination-lg ">
                    <li class="page-item " id="btnGerarLinhas"><a class="page-link bg-primary text-white"
                        href="#tableeee">Mais dados</a></li>
                  </ul>
                </nav>
              </div>
            </div>
          </div>

        </div>

        <script>
          let employeetp1 = [], employeetp2 = [], employeetp3 = [], employeetp4 = [], employeetp5 = [], employeetp6 = [], employeetp7 = [], img = [];

          window.onload = function () {
            var storedUserProfile = localStorage.getItem("userProfile");
            if (storedUserProfile) {
              var userProfile = JSON.parse(storedUserProfile);
              employeetp1 = userProfile.tp1 || [];
              employeetp2 = userProfile.tp2 || [];
              employeetp3 = userProfile.tp3 || [];
              employeetp4 = userProfile.tp4 || [];
              employeetp5 = userProfile.tp5 || [];
              employeetp6 = userProfile.tp6 || [];
              employeetp7 = userProfile.tp7 || [];
              img = userProfile.img || [];
            }
            preencherTabela();
          }

          let mais = 0;

          function preencherTabela() {
            const tabelaCorpo = document.getElementById("tabela-corpo");
            tabelaCorpo.innerHTML = "";  // Limpa a tabela antes de preenchê-la novamente

            // Filtra os produtos que têm quantidade maior que 0 e ordena pela data de validade
            let produtosValidos = employeetp1.map((_, index) => ({
              tp1: employeetp1[index],
              tp2: employeetp2[index],
              tp3: employeetp3[index],
              tp4: employeetp4[index],
              tp5: employeetp5[index],
              tp6: employeetp6[index],
              tp7: employeetp7[index],
              img: img[index]
            })).filter(item => item.tp4 > 0).sort((a, b) => new Date(a.tp3) - new Date(b.tp3));

            // Preenche a tabela até um máximo de 10 linhas
            produtosValidos.slice(mais, mais + 10).forEach((item) => {
              const newRow = tabelaCorpo.insertRow();
              const proximoVencimento = new Date(item.tp3) - new Date() < 1000 * 60 * 60 * 24 * 15;
              if (proximoVencimento) {
                newRow.classList.add("prox-vencimento");
              }
              newRow.innerHTML = `
                      <td>${item.tp1}</td>
                      <td>${item.tp4}</td>
                      <td>R$: ${item.tp5}</td>
                      <td>${item.tp3}</td>
                      <td>${item.tp6}</td>
                      <td>${item.tp7}</td>
                  `;
            });

            mais += 10; // Adiciona mais 10, para a próxima vez que clicar no botão
          }

          document.getElementById("btnGerarLinhas").addEventListener("click", preencherTabela);
        </script>
      </div>
    </div>
    <!-- Fim sessão Grafico -->

  </main>
  <hr>
</body>

</html>